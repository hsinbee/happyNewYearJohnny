<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="stylesheet" href="index.css" />
		<title>HNY_BB_Johnny</title>
	</head>
	<body>
		<div>
			<ul class="light-rope">
				<li></li>
				<li></li>
				<li></li>
				<li></li>
				<li></li>
				<li></li>
				<li></li>
				<li></li>
				<li></li>
				<li></li>
				<li></li>
				<li></li>
				<li></li>
				<li></li>
				<li></li>
				<li></li>
				<li></li>
				<li></li>
				<li></li>
				<li></li>
				<li></li>
				<li></li>
				<li></li>
				<li></li>
				<li></li>
				<li></li>
				<li></li>
				<li></li>
				<li></li>
				<li></li>
				<li></li>
				<li></li>
				<li></li>
				<li></li>
				<li></li>
				<li></li>
				<li></li>
				<li></li>
			</ul>

			<div class="header">
				<h1>
					<div class="newYear">Johnny New Year</div>
					<div class="word title">
						<span>è›‡</span>
						<span>å·´</span>
						<span>æ‹‰</span>
						<span>ç³»</span>
					</div>
					<br />
					<div class="word title">
						<span>æ­</span>
						<span>å–œ</span>
						<span>ç™¼</span>
						<span>è²¡</span>
						<span>ç´…</span>
						<span>åŒ…</span>
						<span>ä¾†</span>
						<span>æ‹¿</span>
					</div>
				</h1>
				<div class="amount">ğŸ¤‘ è«‹è½‰èº«æ‹¿ç´…åŒ…ğŸ¤‘</div>
				<div class="desc">é²ä¾†çš„æ–°å¹´å¿«æ¨‚ ğŸ‰</div>
			</div>

			<div class="mailbox">
				<div class="basis"></div>
				<div class="box">
					<div class="letters">
						<div class="letter letter-second">
							<img class="letter-image" src="https://img.freepik.com/premium-vector/christmas-mail-postcard-hand-drawn-illustration_514781-2114.jpg" />
						</div>
						<div class="letter letter-first">
							<img class="letter-image" src="https://www.shutterstock.com/image-vector/christmas-new-year-postcard-wish-260nw-761840683.jpg" />
						</div>
					</div>
					<div class="slogan-box">
						<div class="slogan-title">ğŸ‰ åˆ®åˆ®æ¨‚ä¾†å•¦ï¼</div>
						<div class="slogan-text">
							ã€Œé€™æ˜¯ä¸€å ´<br />ä¸æµè¡€çš„æˆ°çˆ­ï¼Œåˆ®ï¼ã€ ğŸ¤£
							<span class="star">â˜…</span>
							<span class="star">â˜…</span>
							<span class="star">â˜…</span>
						</div>
					</div>
				</div>
			</div>

			<!-- é›ªæ™¯ -->
			<div class="winter-wrapper" id="winter-wrapper"></div>
			<!-- é›ªåœ° -->
			<div class="ground"></div>

			<div><img src="./img/ginza.png" /></div>
		</div>
		<canvas id="scratchCanvas"></canvas>
		<audio src="img/funny-comedy.mp3" autoplay loop volume="0.1"></audio>

		<script>
			// Snowfall Effect
			(function () {
				const winterWrapper = document.getElementById('winter-wrapper');

				const createSnowflake = (count, className) => {
					for (let i = 1; i <= count; i++) {
						const snowflake = document.createElement('div');
						snowflake.className = `snowflake ${className}-${i}`;

						// éšæœºè®¾ç½®é›ªèŠ±å¤§å°
						const size = Math.random() * 5 + 5; // 5px ~ 20px ä¹‹é—´
						snowflake.style.width = `${size}px`;
						snowflake.style.height = `${size}px`;

						winterWrapper.appendChild(snowflake);
					}
				};

				createSnowflake(250, '_sm');
				createSnowflake(50, '_md');
				createSnowflake(50, '_lg');
			})();

			// Fireworks Effect
			(function () {
				const startFireworks = (x, y) => {
					const candyCount = 150; // æ¯æ¬¡ç”Ÿæˆçš„ "ç…™ç«ç³–æœ" æ•¸é‡
					const colors = ['#ADD8E6', '#B2F2BB', '#FFFACD', '#FFE4E1', '#FFB6C1', '#D8BFD8'];
					const candies = []; // ç”¨ä¾†å­˜å„²ç”Ÿæˆçš„ç…™ç«ç³–æœå…ƒç´ 

					for (let i = 0; i < candyCount; i++) {
						const candy = document.createElement('div');
						candy.classList.add('candy');

						// éš¨æ©Ÿé¸æ“‡é¡è‰²
						const randomColor = colors[Math.floor(Math.random() * colors.length)];
						candy.style.background = randomColor;

						// è¨­ç½®å¤§å°
						const size = Math.random() * 10 + 10; // 5px ~ 15px éš¨æ©Ÿå¤§å°
						candy.style.width = `${size}px`;
						candy.style.height = `${size}px`;

						// è¨­ç½®éš¨æ©Ÿæ–¹å‘
						const angle = Math.random() * 2 * Math.PI; // éš¨æ©Ÿè§’åº¦ (0 ~ 360åº¦)
						const distance = Math.random() * 700 + 50; // éš¨æ©Ÿè·é›¢ (50px ~ 150px)
						const xOffset = Math.cos(angle) * distance;
						const yOffset = Math.sin(angle) * distance;

						// ä½¿ç”¨ CSS è®Šé‡è¨­ç½®å‹•ç•«æ–¹å‘
						candy.style.setProperty('--x', `${xOffset}px`);
						candy.style.setProperty('--y', `${yOffset}px`);

						// è¨­ç½®åˆå§‹ä½ç½®
						candy.style.left = `${x}px`;
						candy.style.top = `${y}px`;

						// å°‡ç³–æœæ·»åŠ åˆ°é é¢
						document.body.appendChild(candy);
						candies.push(candy);
					}

					// ç§»é™¤å‹•ç•«çµæŸçš„ç³–æœå…ƒç´ 
					setTimeout(() => {
						candies.forEach((candy) => candy.remove());
					}, 1250);
				};

				// ç¶å®šé»æ“Šäº‹ä»¶è§¸ç™¼ç…™ç«æ•ˆæœ
				const winterWrapper = document.getElementById('winter-wrapper');
				winterWrapper.addEventListener('click', (event) => {
					startFireworks(event.clientX, event.clientY);
				});

				// è‡ªå‹•éš¨æ©Ÿç”Ÿæˆç…™ç«
				setInterval(() => {
					const x = Math.random() * window.innerWidth;
					const y = Math.random() * window.innerHeight * 0.6; // åƒ…é™å±å¹•ä¸ŠåŠéƒ¨åˆ†
					startFireworks(x, y);
				}, 2000);
			})();
		</script>

		<script>
			// åˆ®åˆ®æ¨‚
			// å–å¾—ä¿¡ç®±å’Œåˆ®åˆ®æ¨‚å®¹å™¨çš„ DOM å…ƒç´ 
			const mailbox = document.getElementById('mailbox');
			const mailDialog = document.getElementById('mail');
			const mailClose = document.getElementById('mailClose');
			const cards = document.querySelectorAll('.card');
			let selectedCard = null;

			// é»æ“Šéƒµç­’æ‰“é–‹éƒµä»¶
			mailbox.addEventListener('click', () => {
				mailDialog.showModal();
			});

			// é»æ“Šå¡ç‰‡ï¼Œç¿»è½‰ä¸¦å•Ÿå‹•åˆ®åˆ®æ¨‚
			cards.forEach((card) => {
				card.addEventListener('click', () => {
					if (selectedCard) return;

					selectedCard = card;
					card.classList.add('flipped', 'selected');

					// è®“å…¶ä»–å¡ç‰‡è®Šç°è‰²ä¸å¯é»æ“Š
					cards.forEach((c) => {
						if (c !== card) c.classList.add('background-card');
					});

					// å•Ÿå‹•åˆ®åˆ®æ¨‚
					const canvas = card.querySelector('.scratch-layer');
					if (!canvas.dataset.initialized) {
						setupScratch(canvas);
						canvas.dataset.initialized = 'true';
					}
				});
			});

			// é»æ“Šé—œé–‰æŒ‰éˆ•ï¼Œæ¢å¾©ç‹€æ…‹
			mailClose.addEventListener('click', () => {
				mailDialog.close();

				cards.forEach((card) => {
					card.classList.remove('flipped', 'selected', 'background-card');
				});

				selectedCard = null;
			});

			// **åˆ®åˆ®æ¨‚åŠŸèƒ½**
			function setupScratch(canvas) {
				console.log('Initializing canvas:', canvas); // æ¸¬è©¦æ˜¯å¦é€²å…¥é€™è£¡
				const ctx = canvas.getContext('2d');
				canvas.width = canvas.offsetWidth;
				canvas.height = canvas.offsetHeight;

				// å¡«å……ç°è‰²é®ç½©
				ctx.fillStyle = '#bfbfbf';
				ctx.fillRect(0, 0, canvas.width, canvas.height);

				let isScratching = false;

				function scratch(e) {
					if (!isScratching) return;

					const rect = canvas.getBoundingClientRect();
					const x = (e.clientX || e.touches[0].clientX) - rect.left;
					const y = (e.clientY || e.touches[0].clientY) - rect.top;

					ctx.globalCompositeOperation = 'destination-out';
					ctx.beginPath();
					ctx.arc(x, y, 15, 0, Math.PI * 2);
					ctx.fill();
				}

				// ç¶å®šäº‹ä»¶
				canvas.addEventListener('mousedown', () => (isScratching = true));
				canvas.addEventListener('mouseup', () => (isScratching = false));
				canvas.addEventListener('mousemove', scratch);

				canvas.addEventListener('touchstart', () => (isScratching = true));
				canvas.addEventListener('touchend', () => (isScratching = false));
				canvas.addEventListener('touchmove', (e) => {
					e.preventDefault();
					scratch(e);
				});
			}
		</script>

		<script>
			const canvas = document.getElementById('scratchCanvas');
			const ctx = canvas.getContext('2d');
			let isDrawing = false;

			function resizeCanvas() {
				canvas.width = canvas.offsetWidth;
				canvas.height = canvas.offsetHeight;
				ctx.fillStyle = 'gray';
				ctx.fillRect(0, 0, canvas.width, canvas.height);
			}

			function startScratch(e) {
				isDrawing = true;
				scratch(e);
			}

			function stopScratch() {
				isDrawing = false;
				checkScratchCompletion();
			}

			function scratch(e) {
				if (!isDrawing) return;
				const rect = canvas.getBoundingClientRect();
				const x = e.clientX - rect.left;
				const y = e.clientY - rect.top;
				ctx.globalCompositeOperation = 'destination-out';
				ctx.beginPath();
				ctx.arc(x, y, 15, 0, Math.PI * 2);
				ctx.fill();
			}

			function checkScratchCompletion() {
				const pixels = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
				let count = 0;
				for (let i = 0; i < pixels.length; i += 4) {
					if (pixels[i + 3] === 0) {
						count++;
					}
				}
				if (count / (canvas.width * canvas.height) > 0.5) {
					canvas.style.display = 'none';
				}
			}

			canvas.addEventListener('mousedown', startScratch);
			canvas.addEventListener('mousemove', scratch);
			canvas.addEventListener('mouseup', stopScratch);
			canvas.addEventListener('mouseleave', stopScratch);
			window.addEventListener('load', resizeCanvas);
		</script>
	</body>
</html>
